# Lambda 架构与 Ka ppa 架构的对比和设计选择

## 最佳实践


### 考察问

1. Lambda架构: 
    1. 组成: 
        1. `()`层(hadoop, hdfs)
        2. `()`层(spark)
        3. `()`层(hbase)
2. Kappa架构
    1. 组成: 放弃`()`层, 仅保留`()`层(加速层)

3. Lambda和Kappa的特点

    |对比内容|Lambda架构|Kappa架构|
    | ---- | ---- | ---- |
    |复杂度与开发、维护成本|需要维护两套系统，复杂度`()`，开发、维护成本`()`|只需要维护一套系统(引擎)，复杂度`()`，开发、维护成本`()`|
    |计算开销|需要一直运行批处理和实时计算，计算开销`()`|必要时进行全量计算，计算开销相对较`()`|
    |实时性|满足实时性|满足实时性|
    |历史数据处理能力|批式全量处理，吞吐量`()`，历史数据处理能力`()`|流式全量处理，吞吐量相对较`()`，历史数据处理能力相对较`()`|

4. 数据分层

    1. `()`(Application Data Service, ADS): 存在业务数据库中, 如MySQL, ES、Redis, 用于业务查询, 形成`()`
    2. `()`(Data Warehouse Service, DWS), 整合成`()`的数据服务层, 用于OLAP、数据分发, 形成`()`
    3. `()`(Data Warehouse Middle, DWM): 在DWD的基础上进行聚合操作，算出相应的`()`, 形成`()`
    4. 数据细节层(Data Warehouse Details, DWD): 业务层和数据仓库层的`()`, 清洗数据, 保持`()`, 形成`()`
    5. 贴源层(Operation Data Store, ODS)直接接入数据的：业务库、埋点日志、消息队列等, 形成`()`



### 考察点

1. Lambda架构: 
    1. 组成: 
        1. `批处`层(hadoop, hdfs)
        2. `加速`层(spark)
        3. `服务`层(hbase)
2. Kappa架构
    1. 组成: 放弃`批处理`层, 仅保留`实时`层(加速层)

3. Lambda和Kappa的特点

    |对比内容|Lambda架构|Kappa架构|
    | ---- | ---- | ---- |
    |复杂度与开发、维护成本|需要维护两套系统，复杂度`高`，开发、维护成本`高`|只需要维护一套系统(引擎)，复杂度`低`，开发、维护成本`低`|
    |计算开销|需要一直运行批处理和实时计算，计算开销`大`|必要时进行全量计算，计算开销相对较`小`|
    |实时性|满足实时性|满足实时性|
    |历史数据处理能力|批式全量处理，吞吐量`大`，历史数据处理能力`强`|流式全量处理，吞吐量相对较`低`，历史数据处理能力相对较`弱`|

4. 数据分层

    1. `应用服务层`(Application Data Service, ADS): 存在业务数据库中, 如MySQL, ES、Redis, 用于业务查询, 形成`报表`
    2. `数仓服务层`(Data Warehouse Service, DWS), 整合成`主题`的数据服务层, 用于OLAP、数据分发, 形成`宽表`
    3. `数仓中间层`(Data Warehouse Middle, DWM): 在DWD的基础上进行聚合操作，算出相应的`统计指标`, 形成`指标表`
    4. 数据细节层(Data Warehouse Details, DWD): 业务层和数据仓库层的`隔离层`, 清洗数据, 保持`和ODS层相同颗粒度`, 形成`清洗表`
    5. 贴源层(Operation Data Store, ODS)直接接入数据的：业务库、埋点日志、消息队列等, 形成`原始表`






## Lambda架构与Kappa架构的特性对比

一个大数据系统架构的设计思想很大程度上受到当时技术条件和思维模式的限制。 Lambda架构将批处理层和速度层分为两层，分别进行离线数据处理和实时数据处理，这样设计的根本原因在于， Lambda 提出的初期是在公司中进行小范围的业务运用，当时并没有思考有没有一个计算引擎能够在可接受的延迟条件下既进行离线数据处理又进行实时数据处理。在这样的前提下，将现有的成熟离线处理技术 (Hadoop)和实时处理技术 (Storm) 相结合，用 Vi ew 模型将二者处理数据后得到的输出结果结合起来，在服务层 (Serving Layer) 中进行统一，开放给上层服务，是相当可行且高效的设计方式。


Kappa 架构作者则对流处理系统有丰富的理论知识和使用经验，是 Apache Kafka 和 ApacheSamza 等知名开源流处理系统的作者之一。基于对流式计算深入的理解， Kappa 架构在同一层次内进行实时处理和离线处理，在满足延迟要求的流式计算技术成熟的前提，比 Lambda 更优秀。表 19-1 从多个维度对 Lambda 架构和 Kappa 架构进行了对比分析。

|对比内容|Lambda 架构|Kappa 架构|
| ---- | ---- | ---- |
|复杂度与开发、维护成本|需要维护两套系统(引擎)，复杂度高，开发、维护成本高|只需要维护一套系统(引擎)，复杂度低，开发、维护成本低|
|计算开销|需要一直运行批处理和实时计算，计算开销大|必要时进行全量计算，计算开销相对较小|
|实时性|满足实时性|满足实时性|
|历史数据处理能力|批式全量处理，吞吐量大，历史数据处理能力强|流式全量处理，吞吐量相对较低，历史数据处理能力相对较弱|



### 复杂度与开发、维护成本

对于大数据系统的评价与比较，首先需要考虑这个系统开发、上线的难度，以及这个系统是否能够以足够低的成本进行维护。

因为需要开发并维护两套系统， Lambda 架构的复杂度相对更高。其中，一套负责进行离线的批处理计算，一般选择使用 Hadoop作为批处理系统，将批处理结果 View 保存到 HBase 中；另一套需要进行实时的流式计算，一般选择 S torm 、 Sp ark 作为流处理系统，流式计算结果将保存到 Redi s 中。

Lambda 架构需要分别在批处理和实时计算系统上面运行两套代码，这两套代码产出相同范式的结果。并且，在进行全量计算时，批处理系统还需要长时间保待运行以保证离线运算结果的正确性。这样的开发维护成本相对较高。

Kappa 架构的复杂度相对低很多，只需要开发并维护一套系统。因为 Ka饮a 对于流式计算有良好支待，易于编程，故一般使用 Ka饮a 作为消息中间件，将数据保存在消息队列中。流式计算系统一般使用 Fli nk 实现，其作为新兴的流处理框架，以数据并行和流水线方式执行任意流数据程序，且同时支持批处理和流处理。开发维护成本相对较低。

### 计算开销

在使用大数据系统进行数据处理时，需要知道数据的存储位置。由于数据量的持续增长，计算对I/0 的需求增长速度已经远远超过网络带宽的扩容速度，故在计算时的开销也是大数据系统的考虑因素之一。


Lambda 架构在计算时，需要让数据同时支持批处理层系统和流处理层系统运行，且在运行时批处理系统和流处理系统都不能停机，否则将会有 View 的合并错误、计算开销大等问题。

Kappa 架构的数据存储只需要面对流式计算，且只需要在必要时进行全量计算，计算消耗小。


### 实时性

实时性要求系统对于一个服务调用可以进行快速响应。快速的定义可能从几毫秒到几秒，取决于用户对于这一功能响应速度的具体要求。在大数据系统中，用户对千快速的要求往往集中在随机读取功能。 Lambda 架构和 Kappa 架构都能够对数据进行实时处理并进行服务的响应。

Lambda 架构的策略在于使用满足么半群( Monoi d) 性质的数据 Vi ew 模型，对批处理层和速度层的输出进行统一管理，这样在新数据到达时，速度层可以实时处理数据得到最新 View,然后和批处理层的 Vi ew 相结合，得到最新的实时结果。这样做的优点是将实时处理变成了批处理和流处理结果的结合，稳定且实时计算成本可控。


Kappa 架构的策略是使用 Kafka 或者类似的分布式消息中间件，用消息队列进行数据的保存，采用并发计算，如果不需要全量计算则直接读出数据。如果需要全量计算，则重新启动一个新的流式计算实例，将所有数据重新读取、计算，直到计算结果完成并超越了原来的结果，再删除原结果，使新结果成为可读取数据。在进行实时的流式数据处理时，如果有大量不同的实时流同时计算，由千算法要求进行关联，十分考验实时计算系统的能力。同时可能因为数据流的先后顺序、算法逻辑等问题导致数据丢失。


### 历史数据处理能力

大数据系统在进行数据处理时，可能需要从大量历史数据中提取出对用户有价值的数据。

Lambda 架构在设计上可以在批处理层中对于超大规模的历史数据进行批量计算。由于批处理层和速度层使用不同的计算系统，在进行批量数据处理时速度层的实时计算仍然可以运行且不受影响。

而 Kappa 架构对于大量历史数据的处理能力相对 Lambda 则相对较弱。 Kappa 在设计上使用了消息队列对数据进行缓存，而消息队列对于数据量和历史数据回溯有性能的制约。在日常需求中算法可能需要一次处理过去一年或者更久的数据，如果这些数据都存在消息队列中，对消息中间件的性能会有非常大的压力。如果数据结果中出现错误需要重新计算，这样数量级的数据对实时流式计算的稳定性和正确性也是一种考验。


## Lambda架构与Kappa架构的设计选择


根据两种架构对比分析，将业务需求、技术要求、系统复杂度、开发维护成本和历史数据处理能力作为选择考虑因素。而计算开销虽然存在一定差别，但是相差不是很大，所以不作为考虑因素。



1. 业务需求与技术要求

    用户需要根据自己的业务需求来选择架构，如果业务对千 Hadoop、 Spark 、 Strom 等关键技术有强制性赖，选择 Lambda 架构可能较为合适；如果处理数据偏好于流式计算，又依赖Flink计算引擎，那么选择Kappa 架构可能更为合适。


2. 复杂度
    如果项目中需要频繁地对算法模型参数进行修改， Lambda 架构需要反复修改两套代码，则显然不如 Kappa 架构简单方便。同时，如果算法模型支待同时执行批处理和流式计算，或者希望用一份代码进行数据处理，那么可以选择 Kappa 架构。
    
    在某些复杂的案例中，其实时处理和离线处理的结果不能统一，比如某些机器学习的预测模型，需要先通过离线批处理得到训练模型，再交由实时流式处理进行验证测试，那么这种情况下，批处理层和流处理层不能进行合并，因此应该选择 Lambda 架构。

3. 开发维护成本

    Lambda 架构需要有一定程度的开发维护成本，包括两套系统的开发、部署、测试、维护，适合有足够经济、技术和人力资源的开发者。而 Kappa 架构只需要维护一套系统，适合不希望在开发维护上投入过多成本的开发者。

4. 历史数据处理能力

    有些情况下，项目会频繁接触海量数据集进行分析，比如过往十年内的地区降水数据等，这种数据适合批处理系统进行分析，应该选择 Lambda 架构。如果始终使用小规模数据集，流处理系统完全可以使用，则应该选择 Kappa 架构。





## 数据仓库概念

数据仓库是一个面向主题的、集成的、相对稳定的、反映历史变化的数据集合，用于支持管理决策。

OLAP服务器：联机分析处理服务器，快速汇总大量数据并进行高效查询分析，为分析人员提供决策支持。

![alt text](数据库/数据仓库概念.png)

## 数据仓库的结构

四个层次:

1. 数据源：是数据仓库系统的基础，是整个系统的数据源泉。
2. 数据的存储与管理：是整个数据仓库系统的核心。
3. OLAP(联机分析处理)服务器：对分析需要的数据进行有效集成，按多维模型组织，以便进行多角度、多层次的分析，并发现趋势。
4. 前端工具：主要包括各种报表工具、查询工具、数据分析工具、数据挖掘工具以及各种基于数据仓库或数据集市的应用开发工具。

## 数据仓库与数据库的对比

|对比项|数据仓库|数据库|
| ---- | ---- | ---- |
|面向对象|面向主题的|面向事务的|
|数据结构|数据结构是集成的，具有一致性|数据结构更为复杂|
|数据状态|是静态的历史数据，只能定期添加、刷新|是动态变化的，业务发生，数据就更新|
|数据类型|存储历史数据|存储实时、在线数据|
|设计冗余|设计需要引入冗余|设计尽量避免冗余|

## 数据分层

1. `应用服务层`(Application Data Service, ADS): 存在业务数据库中, 如MySQL, ES、Redis, 用于业务查询, 形成`报表`
2. `数仓服务层`(Data Warehouse Service, DWS), 整合成`主题`的数据服务层, 用于OLAP、数据分发, 形成`宽表`
3. `数仓中间层`(Data Warehouse Middle, DWM): 在DWD的基础上进行聚合操作，算出相应的`统计指标`, 形成`指标表`
4. 数据细节层(Data Warehouse Details, DWD): 业务层和数据仓库层的`隔离层`, 清洗数据, 保持`和ODS层相同颗粒度`, 形成`清洗表`
5. 贴源层(Operation Data Store, ODS)直接接入数据的：业务库、埋点日志、消息队列等, 形成`原始表`




















































