## 负载均衡

### 服务器集群

![alt text](./负载均衡/26.png)

存在的问题：

1. 用户的请求由谁来转发到具体的应用服务器
2. 用户如果每次访问到的服务器不一样，那么如何维护 session 的一致性(负载均衡和有无状态问题)

解决办法是负载均衡.


### 负载均衡方法

- 应用层：
  
    - `HTTP重定向`

        http 重定向：HTTP 重定向属于应用层的请求转发。当用户发起请求时，该请求先到达 HTTP 重定向负载均衡服务器，服务器依据算法指令让用户重定向，用户收到重定向请求后，才会再次向真正的集群发起请求。

        特点：`实现简单`，`性能较差`

    - `反向代理`

        反向代理服务器：当用户的请求抵达反向代理服务器(此时请求已到达网站机房)，反向代理服务器会按照算法将请求转发至具体的服务器。像常用的 apache、nginx 都能充当反向代理服务器。

        特点：`部署简单`，不过`代理服务器`有可能成为`性能瓶颈` 

- 传输层：

    - `DNS`

        当用户向 DNS 服务器请求获取域名对应的 IP 地址时，DNS 服务器会直接给出经过负载均衡后的服务器 IP。

        特点：与 HTTP 重定向相比，`效率更高`，还能`降低维护负载均衡服务器的成本`。然而，若某个`应用服务器出现故障，无法及时通知 DNS`。并且，`DNS 负载均衡的控制权掌握在域名服务商手中`，网站`难以进行更多优化和强有力的管理`。

    - `NAT`

        这种负载均衡方式是将`一个外部 IP` 地址`映射`为`多个 IP 地址`，每次连接请求时会动态转换为一个内部节点的地址。

        特点：技术较为成熟，一般部署在网关位置，可通过硬件实现。例如四层交换机通常就采用了该技术。

### 负载均衡算法

- 静态算法(不考虑动态负载)
    - 轮转算法：依次将服务请求(任务)调度到不同节点(即服务器)。
    - 加权轮转算法：考虑不同节点处理能力的差异。
    - 源地址哈希散列算法：依据请求的源IP地址，作为散列键从静态分配的散列表找出对应节点。
    - 目标地址哈希散列算法：根据请求目标IP进行散列以找出对应节点。
    - 随机算法：随机分配，方式简单但缺乏可控性。
- 动态算法(考虑动态负载)
    - 最小连接数算法：在每个节点处理能力相同情况下，将新请求分配给当前活动请求数量最少的节点 。
    - 加权最小连接数算法：考虑节点处理能力不同，按最小连接数进行分配。
    - 加权百分比算法：综合考虑节点利用率、硬盘速率、进程个数等，用利用率体现剩余处理能力。
- 硬件负载均衡：如F5。
- 软件负载均衡：例如LVS、Nginx、HAproxy 。
