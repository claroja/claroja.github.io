# 可靠性设计


## 范文

### 摘要

我就职于一家在线教育互联网公司，公司为了深耕中、小学的教学资源消费市场，决定在2017年3月份决定升级一款教学资源搜索与下载产品-“xx校通”。我有幸作为该产品系统架构师，负责了系统架构工作。本文以该产品升级的可靠性设计为例，论述了软件可靠性设计的过程：首先，对产品的开发特点进行分析与回顾主流的可靠性设计技术，其次分析了可靠性设计要求，确定了采用容错设计技术、检错技术满足系统运行的可靠性。最后，重点论述了冗余设计、防卫式程序设计、检错技术的应用过程。事实证明，正是采用合适的、正确的可靠性设计技术，保障了产品上线后的运行稳定。该产品历经7个月时间于2017年10上线，上线之后系统的稳定运行与良好的用户体验得到了用户的一致好评。

### 正文

我就职的企业是一家在线教育互联网公司，公司是国内较大、较权威的k12领域的教学资源提供商之一，涵盖全学科的试题、试卷、学案、教案等各类教学资源700多万套。公司为了深耕中、小学的教学资源消费市场，要能够吸引更多的学校用户，计划在2017年3月份决定升级一款教学资源搜索与下载产品-“校通”。该产品由用户中心、资源网站、资源定制与推荐、资源评价等子系统构成，在历经了7个月的开发后，于10月上线，至今为已有运行半年，良好的用户体验与产品的稳定运行，得到了广大学校的一致好评。公司任命本人为系统架构师，负责了该产品的系统架构工作。软件的可靠性设计，是系统架构的核心工作之一，它的设计合理性直接决定着系统的稳定性，保障了系统运行的质量。

在可靠性设计之前，对产品升级的开发背景进行了解：首先，产品上线后运行4年多的时间，在此期间有多次的功能性完善维护，虽然整体运行稳定，但错误也会偶尔出现，系统的可靠性程度有所下降。其次，该产品历经了多个开发团队维护，代码质量差，系统的扩展较差，已不能满足扩展性需求开发。最后，为了能吸引更多的学校用户，需要对现有产品功能进行较大调整，同时又新增了不少需求。在了解产品升级开发背景后，召开了产品项目会议，决定对该产品重新开发，同时提出对产品进行架构设计，由此提出了系统运行稳定要求，保障系统的可靠性。

在架构设计期间，可靠性的要求是较为明确的，系统的核心模块运行可靠性要有保障。因此我们回顾主流的软件可靠性设计技术：（1）容错设计技术：是应用程序所运行的软件或硬件中发生的错误并从错误中恢复所采用的设计技术，主要包括：恢复块设计、N版本程序设计、冗余设计、卫防式程序设计等，它的设计要求，要有错误自我修复的能力；（2）检错技术：是建立软件系统查错机制，对程序中模块进行监控，一旦超过设定的阈值或检测到错误发出报警通知负责人处理错误，主要包括：漏洞扫描、记录日志等，它的设计要求，要有系统监控与预警错误的能力；（3）降低复杂度设计：通过简化软件结构，缩短程序代码，优化软件数据流向，降低软件复杂度，从而提高软件可靠性，它的设计要求，系统的程序实现是简单的、尽量降低复杂程度。在回顾了主流的软件可靠性设计之后，我们重点的分析了核心功能可靠性设计要求，例如：资源搜索、资源预览、资源下载、扫码支付等这些核心功能，要有错误的修复能力，因此决定采用容错设计技术实现这些功能运行可靠性。另外，要实现系统的错误预警处理，能够对系统出现的异常、错误进行收集与处理，因此决定采用检错技术实现系统监控。

在明确了采用容错设计技术、检错技术的可靠性设计技术后，我们开展了系统的可靠性设计工作。在设计过程中让我印象较深的冗余设计、防卫式程序设计、检错技术的技术应用，下面将着重阐述在可靠性设计过程中这些技术具体应用过程。

冗余设计，包括结构冗余设计、信息冗余设计等，我们在开发过程中主要使用是信息冗余设计，是防止动态产生的数据丢失的问题。在设计记录用户操作日志时，我们使用消息队列技术临时存储这些数据，在消息队列中的数据，按着先进先出的策略插入到日志数据库中，这样能够防止对数据库高并发操作。而在消息队列中的数据是单点的，一旦消息队列中失效，其中的数据也会丢失。因此，在消息队列接收数据后，再将这些数据存储到消息数据库中，防止消息队列的失效而造成的数据丢失。在设计资源搜索功能时，我们将最新、较热的资源数据存储到 Redis（内存数据库）中，用户在搜索资源数据时，只在 Redis 中搜索数据，这样能够提升搜索的效率。而一旦内存溢出，将会导致 Redis 中的数据失效。因此，在数据存储到 Redis 之后，再将这些数据存储到搜索数据库，防止 Redis 的失效而带来的数据丢失。在冗余设计的过程中，让我体会较深的是要对动态产生数据要进行冗余存储，防止数据丢失。

防卫式程序设计，主要用于系统在运行过程可能出现的错误，做出防卫式的程序设计，将出现的错误自动修复。资源下载功能是产品核心功能之一，会员在下载资源时，需要扫描资源金额的二维码，完成支付后才能下载资源。在实现该功能时，需要对接公司的支付中心，在扫描二维码时，需要调用支付中心的接口，将消费信息发送至支付中心，由支付中心完成支付过程，根据支付是否成功的结果决定资源能否下载。为了让用户能够不会因支付失败而导致资源无法下载，我们对该功能进行防卫式程序设计，在调用支付中心的接口时，将消费信息记录在应用端的消费数据库中，一旦支付中心出错，会从消费数据库中读取数据，轮询的向支付中心发送消费信息，同时向支付中心的运维管理员发送短信通知处理问题。正是通过这样的可靠性设计，防止了因支付中心错误而导致的资源下载失败。在防卫式程序的过程中，让我体会较深的是要在设计过程要有风险意识，对会出现的问题做好防卫式程序设计。

检错技术，主要对系统进行监控，一旦超设定阈值或检测到错误发出报警通知负责人处理。为了能够及时的发现错误，我们为系统设计了一套的监控子系统，能够监控功能异常的处理情况、错误日志。为了实现这些监控服务，首先，在程序中加入了异常处理，对功能异常进行捕获与处理，同时异常进行记录，例如，资源下载、扫码充值、资源预览等核心功能加入了 try/catch 代码块；其次，我们封装了错误日志监控组件，这些组件调用集成到各主要程序模块中，收集系统运行过程的出现的错误，例如，null 值、对象不存在、返回值无效等错误。正是通过构建了监控子系统，让我们能够了解系统运行情况，一旦监控到异常、错误时，系统会发短信通知负责人处理问题。在检错技术的应用过程中，让我体会较深的是设计要在系统监控那些功能点，但不是全面监控，而是重点监控。

在历经了7个月的开发，“校通”的升级产品于在2017年10月上线。上线之后我们通过调查问卷、热力图分析与市场的销售的反馈，得了用户的一致好评。正是对系统进行可靠性设计，为产品升级后的新系统提供了运行保障。通过此次产品的升级开发，让我对可靠性设计，有了更深刻的认识，懂得了要对系统中产生核心业务数据做好信息冗余设计、在设计过程要有风险意识并做好防卫式程序设计、构建监控系统来检找系统运行的错误。正是此次开发工作，让我对可靠性设计，有更多知识储备并积累了可贵的经验，对我今后的工作有很大帮助。



✨补充


系统可靠性包括硬件可靠性和软件可靠性，两个方面都需要我们考虑到，软件的复杂度比硬件高，所以软件系统发生故障的概率也会高于硬件系统。硬件在使用时间过长的情况下，物理退化的现象加重，故障发生概率就会变高，通常我们会采用主动冗余、监控检错配合报警的方案来解决。软件系统包含各种的业务逻辑，复杂度较高，故障概率高，通常我们采用防卫式程序设计、N版本程序设计、降低复杂度设计等方案来提高单个服务的自身可靠性；单个服务的可靠性不可能达到百分百，总归避免不了特殊场景下导致服务崩溃无法提供服务支持的情况，针对这一问题通常采用集群部署配合监控报警的方案来解决，即使一台服务崩溃，还有其他服务提供者进行业务支持。合理的采用容错技术方案，可以大大提高服务的可靠性。

在系统中，我们采用了多种容错技术来提高系统的可靠性，下文着重讨论应用系统集群部署、数据库主备部署和程序设计方面在该项目中容错方面具体的应用和效果。

一、系统集群部署容错

单个硬件设备或者说单个软件服务进程，都不可避免的会发生故障导致服务中断。如果单个硬件设备上部署一个或多个软件服务进程，当硬件发生故障，所有软件服务都将不可正常服务；如果一个软件服务就部署了一个进程在提供服务，一旦这个软件进程发生故障，服务也将不可正常运行。针对上述问题，集群部署方案可以很好的解决。同一个软件服务，在不同的多台物理设备上做集群部署，即使一台物理设备发生故障或者一个软件服务进程发生故障，都有其他的多台物理设备和软件进程在提供服务，达到服务永不中断的目的。集群部署就要考虑到请求分发和状态的问题，因为我们的业务是pos机交易，走的是TCP/IP协议，采用了硬件F5做负载分发业务；每个业务进程都尽量做成无状态服务，实在需要处理状态的，我们采用了redis集群来保存状态数据的方案。发生问题的物理设备和软件服务要尽快被发现然后修复，我们采用了zabbix分布式服务监控系统来实现，一旦监控发现问题，立马发送邮件给相关维护人员进行处理。通过集群和监控报警的配合，大大提高了整个系统的可靠性和实时性。

二、数据库主备部署容错

数据库服务是整个收单交易系统的基础服务，每个业务模块都要使用到，所以一旦数据库出现问题，整个服务将中断，影响重大。单个数据库服务不可能说永远不可能出现故障，我们要做到的首先是提升单个数据库服务的可靠性，其次是如果单个数据库服务发生故障，立刻快速使用备用数据库继续支持服务。针对上述问题我们采用了数据库主备部署方案，主备都同时提供服务，每台服务的压力就会减少，提高单台数据库服务的可靠性。主库服务于全部的写操作和少量的读操作，比如说交易业务；备库服务于实时性要求不高的读取操作，比如说内部管理平台查看流水、构建各种报表业务。一旦主库发生故障无法提供服务，备库可以快速的升级为主库，继续提供服务，保证了整个数据库系统的整体可靠性。在数据库的物理文件保存方面，通过磁盘阵列技术做到磁盘容错，防止数据丢失。通过数据库主备部署和磁盘阵列方案，大大提升了数据库服务的可靠性。

三、程序设计方面容错

程序设计方面我们采用了防卫式程序设计以及降低复杂度的策略。防卫式程序设计方面首先是报文字段的检测，报文中各个参数按照预定的规则先进行检测，检测通过后再进行后续的业务处理，比如说交易金额，必须是一个正整数，比如说商户编号必须为固定15位长的字符串，参数检测通过后会大大降低后续业务出现不可控制的错误的概率；其次是异常处理，程序正常逻辑要处理，发生异常的情况下我们也要考虑如何处理，比如说查看商户法人证件照片，读取文件的过程中很可能会出现文件未找到的错误，一旦发生这个错误我们就要按照异常的流程处理，提示说照片文件未找到，不能进行处理；再次是进行错误信息日志记录，程序发生错误时，把相关的详细信息都记录到文件中，方便后续查找定位问题。整体的系统设计我们都采用了合理的架构模式，遵循高内聚、低耦合、单一职责、依赖倒置、接口隔离等基本的设计原则，这些都会降低整个系统的复杂性，增加系统的可靠性。

该项目于`年`月完成测试并上线，通过上述容错方案的实施，整个系统持续稳定的运行，未出现过服务中断的故障，即使系统变更上线，也可以通过集群优势，逐台设备更新上线部署，达到服务不中断的效果。后续我们又完善了zabbix监控系统，丰富了监控的内容，包括硬件设备监控、网络流量监控、软件进程监控、软件业务数据监控等，实现了更加全面的监控策略。错误日志记录追踪发挥了良好的作用，定期我们会排查一遍错误日志，从中分析出系统存在的问题再进行修复，进一步完善系统，进一步提高系统的可靠性。

当然，在我们设计系统和后期运行维护过程中，也陆续发现了一些问题和不足，比如说集群部署导致运维成本增加，后期我们增加了jekins自动部署的功能来解决一些问题。另一个问题就是单个服务不可用时，还是需要人工来处理，不能及时的自动新增一个服务节点上去，目前我们正在研究使用容器技术来解决该问题，等成熟稳定后也会陆续投产使用。


✨redis集群以及哨兵模式



## 仿写


### 摘要




### 正文


软件的可靠性设计，`是系统架构的核心工作之一，它的设计合理性直接决定着系统的稳定性，保障了系统运行的质量`。主流的可靠性设计技术包含:(1)容错设计技术：应用程序运行时发生错误时能自动快速恢复正常运行的技术，主要包含：恢复块设计、N版本程序块设计、冗余设计、防卫式程序设计等（2）检错技术：在软件出现故障后能及时发现并报警，提醒维护人员进行处理。（3）降低复杂度设计：保证实现软件功能的基础上，简化软件结构，缩短程序代码长度，优化软件数据流向，降低软件复杂度，从而提高软件可靠性。（4）系统配置技术：配置多台设备，通过系统的整体保证可靠性，主要包含：双机热备技术和服务器集群技术。其中双机热备技术又可以细分为双机热备模式、双机互备模式、双机双工模式。`在对可靠性设计理论深入研究的基础上，笔者进一步分析了产品开发的需求，并根据这些功能需求进行可靠性的技术选择`。`本文将重点论述其中几个核心功能需求的可靠性设计`，xxx等这些核心功能，要有错误的修复能力，因此决定采用容错设计技术实现这些功能运行可靠性。要实现系统的xxx，因此决定采用检错技术实现系统监控。下面将着重阐述在可靠性设计过程中这些技术具体应用过程。

冗余设计，包括结构冗余设计、信息冗余设计等，我们在开发过程中主要使用是信息冗余设计，是防止动态产生的数据丢失的问题。在设计记录用户操作日志时，我们使用消息队列技术临时存储这些数据，在消息队列中的数据，按着先进先出的策略插入到日志数据库中，这样能够防止对数据库高并发操作。而在消息队列中的数据是单点的，一旦消息队列中失效，其中的数据也会丢失。因此，在消息队列接收数据后，再将这些数据存储到消息数据库中，防止消息队列的失效而造成的数据丢失。在设计资源搜索功能时，我们将最新、较热的资源数据存储到Redis中，用户在搜索资源数据时，只在Redis中搜索数据，这样能够提升搜索的效率。而一旦内存溢出，将会导致Redis中的数据失效。因此，在数据存储到Redis之后，再将这些数据存储到搜索数据库，防止Redis的失效而带来的数据丢失。在冗余设计的过程中，让笔者体会较深的是要对动态产生数据要进行冗余存储，防止数据丢失。✨从两个业务场景论述。

防卫式程序设计，主要用于系统在运行过程可能出现的错误，做出防卫式的程序设计，将出现的错误自动修复。资源下载功能是产品核心功能之一，会员在下载资源时，需要扫描资源金额的二维码，完成支付后才能下载资源。在实现该功能时，需要对接公司的支付中心，在扫描二维码时，需要调用支付中心的接口，将消费信息发送至支付中心，由支付中心完成支付过程，根据支付是否成功的结果决定资源能否下载。为了让用户能够不会因支付失败而导致资源无法下载，我们对该功能进行防卫式程序设计，在调用支付中心的接口时，将消费信息记录在应用端的消费数据库中，一旦支付中心出错，会从消费数据库中读取数据，轮询的向支付中心发送消费信息，同时向支付中心的运维管理员发送短信通知处理问题。正是通过这样的可靠性设计，防止了因支付中心错误而导致的资源下载失败。在防卫式程序的过程中，让我体会较深的是要在设计过程要有风险意识，对会出现的问题做好防卫式程序设计。

检错技术，主要对系统进行监控，一旦超设定阈值或检测到错误发出报警通知负责人处理。为了能够及时的发现错误，我们为系统设计了一套的监控子系统，能够监控功能异常的处理情况、错误日志。为了实现这些监控服务，首先，在程序中加入了异常处理，对功能异常进行捕获与处理，同时异常进行记录，例如，资源下载、扫码充值、资源预览等核心功能加入了try/catch代码块；其次，我们封装了错误日志监控组件，这些组件调用集成到各主要程序模块中，收集系统运行过程的出现的错误，例如，null值、对象不存在、返回值无效等错误。正是通过构建了监控子系统，让我们能够了解系统运行情况，一旦监控到异常、错误时，系统会发短信通知负责人处理问题。在检错技术的应用过程中，让笔者体会较深的是设计要在系统监控那些功能点，但不是全面监控，而是重点监控。


在历经了10个月的开发，“xxx”的升级产品于在2025年4月上线。上线之后，笔者通过调查问卷、评价分析以及市场的销售的反馈，证实该系统获得了用户的一致好评。通过此次产品的升级开发，让笔者对可靠性设计，有了更深刻的认识，懂得了要对系统中产生核心业务数据做好信息冗余设计、在设计过程要有风险意识并做好防卫式程序设计、构建监控系统来检找系统运行的错误。正是此次开发工作，让笔者对可靠性设计，有更多知识储备并积累了可贵的经验，对笔者今后的工作有很大帮助。




