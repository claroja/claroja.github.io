# 单因素方差分析

根据所分析的分类型自变量的多少，方差分析可分为单因素方差分析和双因素方差分析。当方差分析只涉及一个分类型自变量时，称为单因素方差分析(one-way analysis of variance).如，要检验不同行业被投诉次数的均值是否相等，这里只涉及行业一个因素，因而属于单因素方差分析。


## 分析步骤

### 提出假设

在方差分析中，原假设所描述的是在按照自变量的取值分成的类中，因变量的均值相等。因此，检验因素的k个水平（总体）的均值是否相等，需要提出如下形式的假设：

$$
H_0: \mu_1=\mu_2=...=\mu_k 自变量对因变量没有显著影响 \\
H_1: \mu_1, \mu_2, ..., \mu_k 自变量对因变量有显著影响
$$

其中, $\mu_i$为第$i$个总体的均值

### 构造检验的统计量

1. 计算各分类样本的均值

    假定从第$i$个总体中抽取一个容量为$n_i$的简单随机样本，令$\overline{x}_i$为第$i$个总体的样本均值，则有:
    $$
    \overline{x}_i = \frac{\sum_{j=1}^{n_i} x_{ij}}{n_i}, i=1,2,...,k
    $$

    式中，$n_i$为第$i$个总体的样本量；$x_{ij}$为第$i$个总体的第$j$个观测值。例如，计算零售业的样本均值为：
    $$
    \overline{x}_1 = \frac{\sum_{j=1}^{n_1} x_{1j}}{n_1}=\frac{57+66+49+40+34+53+44}{7}=49
    $$

    同样可以得到旅游业$\overline{x}_2=48$、航空业$\overline{x}_3=35$、家电制造业$\overline{x}_4=59$的均值。


2. 计算全部观测值的总均值

    全部观测值的总和除以观测值总个数, 另总均值为$\overline{x}$, 有:
    $$
    \overline{x} = \frac{\sum_{i=1}^k\sum_{j=1}^{n_i} x_{ij}}{n} = \frac{\sum_{i=1}^k n_i \overline{x}_i}{n}
    $$

    其中, $n=n_1 + n_2 + ... + n_k$


    总体的均值为$\overline{x}=\frac{57+66+...+77+58}{23}=47.87$


3. 计算各误差平方和

    在方差分析中，需要计算三个误差平方和，它们是总平方和、组间平方和（因素平方和）、组内平方和（误差平方和或残差平方和）。

    1. 总平方和(sum of squares for total), 记为SST。它是全部观测值$x_{ij}$, 与总均值$\overline{x}$的误差平方和，其计算公式为：

    $$
    SST = \sum_{i=1}^k \sum_{j=1}^{n_i} (x_{ij}-\overline{x})^2
    $$

    案例中的结果为:

    $$
    SST = (57-47.87)^2 + ... + (58-47.87)^2 = 4164.61
    $$

    反映了全部23个观测值与这23个观测值平均数之间的差异.

    2. 组间平方和(sum of squares for factor A),记为SSA,它是各组均值$\overline{x}(i=l,2,...,k)$与总均值$\overline{x}$的误差平方和，反映各样本均值之间的差异程度，又称为因素平方和。其计算公式为：

    $$
    SSA = \sum_{i=1}^k n_i(\overline{x}_i - \overline{x})^2
    $$

    案例中的结果为:
    $$
    SSA = \sum_{i=1}^4 n_i(\overline{x}_i - \overline{x})^2 = 7*(49-47.87)+6*(48-47.87)+5*(35-47.87)+5*(59-47.87)=1456.61
    $$

    3. 组内平方和(sum of squares for error),记为SSE。它是每个水平或组的各样本数据与其组均值的误差平方和，反映每个样本各观测值的离散状况，又称为误差平方和。该平方和反映了随机误差的大小，其计算公式为：
    $$
    SSE = \sum_{i=1}^k \sum_{j=1}^{n_i}(x_{ij}-\overline{x}_i)^2
    $$

    案例中, 先求出每个行业被投诉次数与其均值的误差平方和，然后将四个行业的误差平方和加总，即为SSE。例如，计算误差平方和分别为：

    零售业:
    $$
    \sum_{j=1}^7(x_{1j}-\overline{x}_1)^2 = (57-49)^2+(66-49)^2+...+(44-49)^2=700
    $$
    旅游业:
    $$
    \sum_{j=1}^6(x_{2j}-\overline{x}_2)^2 = (68-48)^2+(39-48)^2+...+(51-48)^2=924
    $$
    航空业:
    $$
    \sum_{j=1}^5(x_{3j}-\overline{x}_3)^2 = (31-35)^2+(49-35)^2+...+(40-35)^2=434
    $$
    家电制造业:
    $$
    \sum_{j=1}^5(x_{4j}-\overline{x}_4)^2 = (44-59)^2+(51-59)^2+...+(58-59)^2=650
    $$
    加总可以得到:
    $$
    SSE = 700 + 924 + 434 + 650 = 2708
    $$
    上述三个平方和之间的关系为:
    $$
    \sum_{i=1}^k\sum_{j=1}^{n_i}(x_{ij}-\overline{x})^2 = \sum_{i=1}^k n_i(\overline{x}_i - \overline{x})^2 + SSE = \sum_{i=1}^k \sum_{j=1}^{n_i}(x_{ij}-\overline{x}_i)^2
    $$

    可以根据上述案例进行验证:
    $$
    4164.61 = 1456.61 + 2708
    $$

    从上述三个误差平方和可以看出，SSA是对随机误差和系统误差大小的度量，它反映了自变量（行业）对因变量（被投诉次数）的影响，也称为自变量效应或因子效应；SSE是对随机误差大小的度量，它反映了除自变量对因变量的影响之外其他因素对因变量的总影响，因此SSE也称为残差变量，它所引起的误差称为残差效应；SST是对全部数据总误差程度的度量，它反映了自变量和残差变量的共同影响，因此等于自变量效应加残差效应。


4. 计算统计量

    由于各误差平方和的大小与观测值的多少有关，为了消除观测值多少对误差平方和大小的影响，需要将其平均，也就是用各平方和除以它们所对应的自由度，这一结果称为均方(mean square),也称方差。三个平方和所对应的自由度分别为：
    - SST的自由度为$n-1$，其中$n$为全部观测值的个数。
    - SSA的自由度为$k-1$，其中$k$为因素水平（总体）的个数。
    - SSE的自由度为$n-k$。

    由于要比较的是组间均方和组内均方之间的差异，所以通常只计算SSA的均方和SSE的均方。SSA的均方也称组间均方或组间方差，记为MSA,其计算公式为：
    $$
    MSA = \frac{组间平方和}{自由度}=\frac{SSA}{k-1}
    $$
    案例中的MSA为
    $$
    MSA = \frac{SSA}{k-1} = \frac{1456.61}{4-1} = 485.54
    $$

    SSE的均方也称为组内均方或组内方差，记为MSE,其计算公式为：
    $$
    MSE = \frac{组内平方和}{自由度} = \frac{SSE}{n-k}
    $$
    案例中的MSE为:
    $$
    MSE = \frac{SSE}{n-k} = \frac{2708}{23-4} = 142.53
    $$

    将上述MSA和MSE进行对比，即得到所需要的检验统计量$F$。当$H_0$为真时，二者的比值服从分子自由度为$k一1$、分母自由度为$n一k$的$F$分布，即
    $$
    F = \frac{MSA}{MSE}\sim F(k-1,n-k)
    $$
    案例中的$F$为:
    $$
    F = \frac{MSA}{MSE}=\frac{485.54}{142.53}=3.41
    $$

### 作出统计决策

如果原假设$H_0: \mu_1 = \mu_2 = ... = \mu_i = ... = \mu_k$成立，则表明没有系统误差，组间方差
MSA与组内方差MSE的比值差异就不会太大；如果组间方差显著大于组内方差，说明各水平（总体）之间的差异显然不仅有随机误差，还有系统误差。用例10.1来说，如果行业对被投诉次数没有影响，那么4个行业被投诉次数的均值之间的差异与每个行业被投诉次数的内部差异相比，不会相差很大；反之，则意味着行业对被投诉次数有影响。可见，判断因素的水平是否对观测值有显著影响，实际上也就是比较组间方差与组内方差之间差异的大小。

根据给定的显著性水平$\alpha$,在F分布表中查找与分子自由度$df_1=k一1$、分母自由度
$df_2=n一k$相应的临界值$F_{\alpha}(k一1,n一k)$.
- 若$F>F_\alpha$，则拒绝原假设$H_0: \mu_1=\mu_2=...=\mu_k$,表明$\mu_i(i=1,2,...,k)$之间的差异是显著的；也就是说，所检验的因素（行业）对观测值（被投诉次数）有显著影响。
- 若$F<F_\alpha$，则不拒绝原假设$H_0$,没有证据表明$\mu_i(i=1,2,...,k)$之间有显著差异；也就是说，这时还不能认为所检验的因素（行业）对观测值（被投诉次数）有显著影响。

例如，根据上面的计算结果，计算出$F=3.406643$。若取显著性水平$\alpha=0.05$,根据分子自由度$df_1=k-1=4-1=3$和分母自由度$df_2=n-k=23-4=19$,查$F$分布表得到临界值$F_{0.05}(3,19)=3.13$。由于$F>F_\alpha$。因此拒绝原假设$H_0: \mu_1=\mu_2=...=\mu_k$,表明$\mu_1, \mu_2, ,\mu_3, \mu_5$之间有显著差异，即行业对被投诉次数有显著影响。


### 方差分析表
将上述过程的内容列在一张表内，这就是方差分析表(analysis of variance table), 一般形式为:
误差来源|平方和(SS)|自由度(df)|均方(MS)|F值|P值|F临界值
--|--|--|--|--|--|--
组间(因素影响)|SSA|$k-1$|MSA|MSA/MSE
组内(误差)|SSE|$n-k$|MSE
总和|SST|$n-1$

将上述案例带入:
误差来源|平方和(SS)|自由度(df)|均方(MS)|F值|P值|F临界值
--|--|--|--|--|--|--
组间(因素影响)|1456.61|3|485.54|3.41|0.039|3.13
组内(误差)|2708|19|142.53
总和|4164.61|22


## 关系强度的测量

只要组间平方和(组间SS)不等于零，就表明两个变量之间有关系（只是是否显著的问题）。当组间平方和比组内平方和(组内SS)大，而且大到一定程度时，就意味着两个变量之间的关系显著，大得越多，表明它们之间的关系就越强；反之，当组间平方和比组内平方和小时，就意味着两个变量之间的关系不显著，小得越多，表明它们之间的关系就越弱。

可以用组间平方和(SSA)占总平方和(SST)的比例大小来反映，将这一比例记为R,即
$$
R^2 = \frac{SSA(组间SS)}{SST(总SS)}
$$

案例带入

$$
R^2 = \frac{SSA(组间SS)}{SST(总SS)} = \frac{1456.61}{4164.61} = 0.35 = 35%
$$

这表明，行业（自变量）对被投诉次数（因变量）的影响效应占总效应的34.9759%，而残差效应则占65.0241%。也就是说，行业对被投诉次数差异解释的比例达到近35%，而其他因素（残差变量）所解释的比例为65%以上。尽管R并不高，但行业对被投诉次数的影响已经达到统计上显著的程度。


## 方差分析中的多重比较

通过分析得出的结论是：不同行业被投诉次数的均值不完全相同。但究竟哪些均值之间不相等？这种差异到底出现在哪些行业之间？也就是说，$\mu_1$与$\mu_2$、$\mu_1$与$\mu_3$、$\mu_1$与$\mu_4$、$\mu_2$与$\mu_3$、$\mu_2$与$\mu_4$、$\mu_3$与$\mu_4$之间究竟是哪两个均值不同？这就需要作进一步的分析，所使用的方法就是多重比较方法(multiple comparison procedures),它是通过对总体均值之间的配对比较来进一步检验到底哪些均值之间存在差异。

多重比较方法有许多种，这里介绍由费希尔提出的最小显著差异方法(least signifi-cant difference),缩写为LSD。使用该方法进行检验的具体步骤为：
1. 第1步: 提出假设: $H_0: \mu_i = \mu_j; H_1: \mu_i \neq \mu_j$
2. 第2步: 计算检验统计量: $\overline{x}_i - \overline{x}_j$
3. 第3步: 计算LSD, 公式为: 

    $$
    LSD = t_{\alpha/2}\sqrt{MSE(\frac{1}{n_i}+\frac{1}{n_j})}
    $$

    其中, $t_{\alpha/2}$为$t$分布的临界值, 查$t$分布表得到, 其自由度为$n-k$, 这里的$k$是因素中水平的个数; MSE为组内方差; $n_i$和$n_j$分别是第$i$个样本和第$j$个样本的样本量.

4. 第4步: 根据显著性水平$\alpha$做出决策. 如果$|\overline{x}_i - \overline{x}_j|>LSD$, 则拒绝$H_0$;如果$|\overline{x}_i - \overline{x}_j|<LSD$, 则不拒绝$H_0$.

将案例带入:

1. 第1步: 提出假设

    - 检验1: $H_0: \mu_1 = \mu_2; H_1: \mu_1 \neq \mu_2$
    - 检验2: $H_0: \mu_1 = \mu_3; H_1: \mu_1 \neq \mu_3$
    - 检验3: $H_0: \mu_1 = \mu_4; H_1: \mu_1 \neq \mu_4$
    - 检验4: $H_0: \mu_2 = \mu_3; H_1: \mu_2 \neq \mu_3$
    - 检验5: $H_0: \mu_2 = \mu_4; H_1: \mu_2 \neq \mu_4$
    - 检验6: $H_0: \mu_3 = \mu_4; H_1: \mu_3 \neq \mu_4$

2. 第2步: 计算检验统计量

- $|\overline{x}_1-\overline{x}_2|$ = |49 - 48| = 1
- $|\overline{x}_1-\overline{x}_3|$ = |49 - 35| = 14
- $|\overline{x}_1-\overline{x}_4|$ = |49 - 59| = 10
- $|\overline{x}_2-\overline{x}_3|$ = |48 - 35| = 13
- $|\overline{x}_2-\overline{x}_4|$ = |48 - 59| = 11
- $|\overline{x}_3-\overline{x}_4|$ = |35 - 59| = 24

3. 第3步: 计算LSD, $MSE=142.53$. 由于4个行业样本量不同, 分别计算LSD. 根据自由度=$n-k$=23-4=19, 查$t$分布表得$t_{\alpha/2}=t_{0.025}=2.093$.

- 检验1: $LSD_1=2.093 * \sqrt{142.53 * (\frac{1}{7}+\frac{1}{6})}=13.90$
- 检验2: $LSD_2=2.093 * \sqrt{142.53 * (\frac{1}{7}+\frac{1}{5})}=14.63$
- 检验3: $LSD_3=LSD_2=14.63$
- 检验4: $LSD_4=2.093 * \sqrt{142.53 * (\frac{1}{6}+\frac{1}{5})}=15.13$
- 检验5: $LSD_5=LSD_4=15.13$
- 检验6: $LSD_6=2.093 * \sqrt{142.53 * (\frac{1}{5}+\frac{1}{5})}=15.80$

4. 第4步: 做出决策

- $|\overline{x}_1 - \overline{x}_2|=1<13.90$, 不拒绝$H_0$, 不能认为零售业与旅游业被投诉次数之间有显著差异
- $|\overline{x}_1 - \overline{x}_3|=14<14.63$, 不拒绝$H_0$, 不能认为零售业与航空业被投诉次数之间有显著差异
- $|\overline{x}_1 - \overline{x}_4|=10<14.63$, 不拒绝$H_0$, 不能认为零售业与家电制造业被投诉次数之间有显著差异
- $|\overline{x}_2 - \overline{x}_3|=13<15.13$, 不拒绝$H_0$, 不能认为旅游业与航空业被投诉次数之间有显著差异
- $|\overline{x}_2 - \overline{x}_4|=11<15.13$, 不拒绝$H_0$, 不能认为旅游业与家电制造业被投诉次数之间有显著差异
- $|\overline{x}_3 - \overline{x}_4|=24<15.80$, 拒绝$H_0$, 认为航空业与家电制造业被投诉次数之间有显著差异

