# 文件服务

## 1. 需求背景

文件的上传、下载功能是软件系统常见的功能，包括上传文件、下载文件、查看文件等。例如：电商系统中需要上传商品的图片、广告视频，办公系统中上传附件，社交类系统中上传用户头像等等。

文件上传下载大致流程为：

![alt text](中台系统/文件系统_传统.png)

这种方式开发起来简单、直接，但是有一些问题：

- 重复开发： 比如对接某个OSS(Object Storage Service,简称OSS)服务商， 每个应用都需要对接该服务商，重复工作
- 扩展性差： 当需要切换服务商时，所有涉及到的应用都需要修改、测试、上线

基于以上原因，微服务体系下的应用系统一般都有一个文件服务，用于统一管理文件上传下载等功能，大型电商系统甚至有独立的文件、图片、视频服务。此时架构体系变为：

![alt text](中台系统/文件系统_中台.png)

这种方式提供一个独立的文件微服务，该微服务向应用系统提供统一的上传、下载、查看接口，应用系统调用方式相同，并且屏蔽了底层对外调用OSS服务的接口，即使以后迁移OSS服务商，应用层面的系统也不需要变动。

这种模式也有一个小问题，比如我们调用了阿里云的OSS服务，如果所有的下载、查看功能都调用文件服务，那么文件服务的网络流量将会有非常大的压力。所以常用的做法是这样的：

![alt text](中台系统/文件系统_中台优化.png)

## 2. 核心功能

文件服务的核心功能是： **上传**和**下载**， 另一方面，除了这两个核心功能，还需要其他非功能性要求：

- 可用性：作为基础性服务，可用性要求非常高
- 配置性：OSS服务商配置、上传下载方式等内容
- 扩展性：能方便的进行扩展，如添加新的OSS服务商等

本课程的文件服务提供两种类型的服务：

- 面对应用系统的通用附件服务

​   提供统一的上传接口，屏蔽底层的存储方案（本地存储、FastDFS、阿里云存储、七牛云存储等），可独立运行服务

- 面对用户的网盘服务

​   有文件夹和文件的概念，支持大文件分片上传、合并

## 3. 存储策略

### 3.1 本地存储

本地存储，即将上传的文件存储在本地磁盘，并通过本地提供的Nginx服务来对外提供文件的下载和查看等功能。

### 3.2 FastDFS存储

FastDFS存储，即将上传的文件存储在FastDFS分布式文件存储系统中，并通过FastDFS结合Nginx提供的服务来对外提供文件的下载和查看等功能。

### 3.3 云存储

云存储，即将上传的文件存储在第三方云平台上，例如阿里云OSS、七牛云OSS服务等，并通过这些第三方提供的OSS服务来对外提供文件的下载和查看等功能。




## 分片上传

### 5.10.1 分片上传介绍

分片上传就是把一个大文件进行分片，一片一片的上传到服务端，最后由服务端进行分片的合并。

要实现分片上传需要前端和后端配合来完成。在进行分片上传时，一般是由前端对要上传的大文件进行分片，然后分多次将这些分片上传到服务端，所有分片都上传到服务端后，在服务端将分片合并为原始的大文件。采用大文件分片并发上传，可以极大的提高文件的上传效率。

### 5.10.2 前端分片上传插件webuploader

WebUploader是由Baidu WebFE(FEX)团队开发的一个简单的以HTML5为主，FLASH为辅的现代文件上传组件。在现代的浏览器里面能充分发挥HTML5的优势，同时又不摒弃主流IE浏览器，沿用原来的FLASH运行时，兼容IE6+，iOS 6+, android 4+。

官网地址：http://fex.baidu.com/webuploader/

分片与并发结合，将一个大文件分割成多块，并发上传，极大地提高大文件的上传速度。

当网络问题导致传输错误时，只需要重传出错分片，而不是整个文件。另外分片传输能够更加实时的跟踪上传进度。











