# Sentinel

## 背景

微服务架构设计由众多微服务组成，为保障高可用，通常会采用集群方式部署。由于服务自身原因或网络等其他问题，并不能保证100%可用性， 若单个服务出现问题， 会导致进入该服务的线程阻塞， 如果大量请求， 服务可能瘫痪， 服务与服务之间的依赖性， 故障会传播， 产生雪崩效应， 为解决和规避此问题， 业界提出熔断器模型， 衍生出了Sentinel，Hystrix和Resilience4j等组件。

## 流量控制

流量控制在网络传输中是一个常用的概念，它用于调整网络包的发送数据。然而，从系统稳定性角度考虑，在处理请求的速度上，也有非常多的讲究。任意时间到来的请求往往是随机不可控的，而系统的处理能力是有限的。我们需要根据系统的处理能力对流量进行控制。Sentinel 作为一个调配器，可以根据需要把随机的请求调整成合适的形状。

![alt text](金融项目/sentinel_flow.jpg)

## 熔断降级

与Hystrix熔断理念一致， 主要控制调用链中的不稳定资源， 针对这些不同场景进行限制， 避免影响整体系统的稳定性， 防止出现穿透、雪崩等灾难性问题。
在熔断实现上， Sentinel与Hystrix存在较大差异：

+ Hystrix 是通过线程池隔离， 增加线程切换开销，侵入性较强， 且异步方式，不便主线程控制处理。
+ Sentinel 前置处理， 限制请求线程并发数量来控制， 这样避免线程切换开销，侵入性低。
+ Sentinel 还可以针对响应时间对资源进行降级， 当某个资源出现响应时间过长， 所有对该资源的访问都会被拒绝， 直到配置的指定时间窗口之后才重新恢复访问。

## 主要特性视图

![sentinel_feature](金融项目/sentinel_feature.png)

## 工作原理

**框架设计**

![sentinel_framework](金融项目/sentinel_framework.gif)

**设计说明**

在 Sentinel 里面，所有的资源都对应一个资源名称以及一个 Entry。Entry 可以通过对主流框架的适配自动创建，也可以通过注解的方式或调用 API 显式创建；每一个 Entry 创建的时候，同时也会创建一系列功能插槽（slot chain）。这些插槽有不同的职责，例如:

+ NodeSelectorSlot 负责收集资源的路径，并将这些资源的调用路径，以树状结构存储起来，用于根据调用路径来限流降级；
+ ClusterBuilderSlot 则用于存储资源的统计信息以及调用者信息，例如该资源的 RT, QPS, thread count 等等，这些信息将用作为多维度限流，降级的依据；
+ StatisticSlot 则用于记录、统计不同纬度的 runtime 指标监控信息；
+ FlowSlot 则用于根据预设的限流规则以及前面 slot 统计的状态，来进行流量控制；
+ AuthoritySlot 则根据配置的黑白名单和调用来源信息，来做黑白名单控制；
+ DegradeSlot 则通过统计信息以及预设的规则，来做熔断降级；
+ SystemSlot 则通过系统的状态，例如 load1 等，来控制总的入口流量；

## 降级演示

1. **平均响应时间演示**
    当资源的平均响应时间超过阈值（DegradeRule 中的 count，以 ms 为单位）之后，资源进入准降级状态。如果接下来 1s 内持续进入 5 个请求（即 QPS >= 5），它们的 RT 都持续超过这个阈值，那么在接下的时间窗口（DegradeRule 中的 timeWindow，以 s 为单位）之内，对这个方法的调用都会自动地熔断（抛出 DegradeException）。注意 Sentinel 默认统计的 RT 上限是 4900 ms，超出此阈值的都会算作 4900 ms，若需要变更此上限可以通过启动配置项 -Dcsp.sentinel.statistic.max.rt=xxx 来配置。

2. **异常比例演示**
    当资源的每秒请求量 >= 5，并且每秒异常总数占通过量的比值超过阈值（DegradeRule 中的 count）之后，资源进入降级状态，即在接下的时间窗口（DegradeRule 中的 timeWindow，以 s 为单位）之内，对这个方法的调用都会自动地返回。异常比率的阈值范围是 [0.0, 1.0]，代表 0% - 100%。

## 限流演示

流量控制（flow control），其原理是监控应用流量的 QPS 或并发线程数等指标，当达到指定的阈值时对流量进行控制，以避免被瞬时的流量高峰冲垮，从而保障应用的高可用性。
