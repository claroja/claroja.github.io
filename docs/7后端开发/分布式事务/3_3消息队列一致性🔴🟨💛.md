# 消息队列实现最终一致性

## 最佳实践

### 考察问

1. 订单服务和库存服务完成`()`和`()`资源
2. 订单服务在本地事务中完成
    1. `()`
    2. `()`
3. 由`()`根据`()`的记录发送给MQ通知`()`执行减库存操作
4. 库存服务在本地事务中完成
    1. `()`，
    2. 并且`()`（为避免重复执行消息，在执行减库存之前查询是否执行过此消息）
5. 库存服务向MQ发送`()`
6. 订单服务接收到完成库存减少的消息后`()`

![alt text](./分布式事务/消息队列实现最终一致性_评估.png)

- 优缺点:
    - 优点：`()`，性能`()`。开发成本比TCC`()`。
    - 缺点：浪费`()`资源，另外对于高并发操作不是最佳方案。

### 考察点

1. 订单服务和库存服务完成`检查`和`预留`资源
2. 订单服务在本地事务中完成
    1. `添加订单表记录`
    2. `添加消息表记录:减少库存任务消息`
3. 由`定时任务`根据`消息表`的记录发送给MQ通知`库存服务`执行减库存操作
4. 库存服务在本地事务中完成
    1. `执行减少库存`，
    2. 并且添加`消息表记录: 执行消息状态`记录（为避免重复执行消息，在执行减库存之前查询是否执行过此消息）
5. 库存服务向MQ发送`完成减少库存的消息`
6. 订单服务接收到完成库存减少的消息后`删除原来添加的“减少库存任务消息”`

![alt text](./分布式事务/消息队列实现最终一致性.png)

- 优缺点:

    - 优点：`异步解耦`，性能`高`。开发成本比TCC`低`。
    - 缺点：浪费`数据库`资源，另外对于高并发操作不是最佳方案。

## 消息队列一致性

本方案是将分布式事务拆分成多个本地事务来完成，并且由消息队列异步协调完成。下边以下单减少库存为例来说明：

![alt text](./分布式事务/消息队列实现最终一致性.png)

1. 订单服务和库存服务完成`检查`和`预留`资源
2. 订单服务在本地事务中完成添加`订单表记录`和添加`消息表记录: 减少库存任务消息`
3. 由`定时任务`根据`消息表`记录发送给MQ通知库存服务执行`减库存`操作
4. 库存服务执行`减少库存`，并且添加`消息表记录: 执行消息状态`记录（为避免重复执行消息，在执行减库存之前查询是否执行过此消息）
5. 库存服务向MQ发送`完成减少库存的消息`
6. 订单服务接收到完成库存减少的消息后`删除原来添加的“减少库存任务消息”`

实现最终事务一致性要求：预留资源成功理论上要求正式执行成功，如果执行失败会进行重试，要求业务执行方法实现幂等。


## 优缺点

- 优点：由MQ按异步的方式协调完成事务，`性能`较高。不用实现try/confirm/cancel接口，`开发成本`比TCC低。
- 缺点：此种方式基于关系数据库本地事务来实现，会出现频繁读写数据库记录，`浪费数据库资源`，另外对于高并发操作不是最佳方案。
