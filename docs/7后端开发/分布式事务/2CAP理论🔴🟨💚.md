# 分布式事务

## 最佳实践

### 考察问

- CAP理论
    - CAP包含三个部分: `()`, `()`, `()`
        - 一致性: 不能让请求者读到`()`的数据
        - 可用性: 请求在`()`时间内`()`结果返回
        - 分区容忍性: 如果出现了`()`问题，分布式系统还需要继续`()`。

    - CAP两两组合:
        - CP：当一套系统在发生`()`后，客户端的任何请求都被`()`或者`()`，但是，系统的每个节点总是会返回`()`的数据.
        - AP：当一套系统在发生`()`后，可以返回`()`数据, 放弃`()`一致性仅追求`()`一致性

- BASIC理论

    - BA：`()`

        整个系统在某些不可抗力的情况下，仍然能够保证“可用性”，即一定时间内仍然能够返回一个明确的结果。只不过“基本可用”和“高可用”的区别是：

        - 🌰响应可以适当`()`, 如当举行大促时，响应时间可以适当延长
        - 🌰返回结果进行`()`, 如给部分用户直接返回一个降级页面，从而缓解服务器压力。

    - S：`()`

        同一数据的不同副本的状态，可以不需要`()`一致。

    - E：`()`

        同一数据的不同副本的状态，可以不需要实时一致，但一定要保证经过一定时间后仍然是一致的。

### 考察点

- CAP理论
    - CAP包含三个部分: `一致性`, `可用性`, `分区容忍性`
        - 一致性: 不能让请求者读到`不一样`的数据
        - 可用性: 请求在`给定`时间内`有`结果返回
        - 分区容忍性: 如果出现了`分区`问题，分布式系统还需要继续`运行`。

    - CAP两两组合:
        - CP：当一套系统在发生`分区故障`后，客户端的任何请求都被`阻塞`或者`超时`，但是，系统的每个节点总是会返回`一致`的数据.
        - AP：当一套系统在发生`分区故障`后，可以返回`不一致`数据, 放弃`强`一致性仅追求`最终`一致性

- BASIC理论

    - BA：`基本可用(Basic Available)`

        整个系统在某些不可抗力的情况下，仍然能够保证“可用性”，即一定时间内仍然能够返回一个明确的结果。只不过“基本可用”和“高可用”的区别是：

        - 🌰响应可以适当`延长`, 如当举行大促时，响应时间可以适当延长
        - 🌰返回结果进行`降级`, 如给部分用户直接返回一个降级页面，从而缓解服务器压力。

    - S：`柔性状态(Soft State)`

        同一数据的不同副本的状态，可以不需要`实时`一致。

    - E：`最终一致性(Eventual Consisstency)`

        同一数据的不同副本的状态，可以不需要实时一致，但一定要保证经过一定时间后仍然是一致的。

## CAP理论

CAP理论是分布式事务处理的理论基础，其内容是：分布式系统在设计时只能在一致性(Consistency)、可用性(Availability)、分区容忍性(Partition Tolerance)中满足两种，无法兼顾三种。

✨由于CAP是学术理论，并不是工程理论，它会舍弃很多现实世界的问题。比如网络的时长，比如节点内部的处理速度不一致，比如节点间存储方式和速度的不一致。它说的一致性就是客户端是否能拿到最新数据，它说的可用性就是允许客户端拿不到最新数据。

### CAP包含三个部分

通过下图理解CAP理论：

![alt text](./CAP理论/CAP理论.png)

- 一致性(Consistency)：服务A、B两个结点都存储了用户数据, 当一个A节点数据发生改变后, B节点也要发生一样的改变, 不能让请求者读到不一样的数据。这时AB改变数据就变成了一个事务, 在事务中, 请求无法返回数据.

- 可用性(Availability)：请求在`给定`时间内`有`结果返回。
    - 给定`时间`: 如果业务定的 100 毫秒，结果却在 1 秒才返回，那么这个系统就不满足可用性。
    - 有结果返回:
        - A节点`宕机`, B节点`正常返回`, 系统依然是可用的
        - A节点`最新`数据, B节点是`上一版本`的数据, 返回上一版本的数据, 系统仍然是可用的

- 分区容忍性(Partition Tolerance)：分布式系统是多个系统通过网络协同工作的，节点之间难免会出现网络中断、网延延迟等现象，这就是网络分区。既节点通信出现了问题，那么就出现了分区。分区容忍性是指如果出现了分区问题，我们的分布式存储系统还需要继续运行。

### CAP两两组合

同时满足“一致性”、“可用性”和“分区容忍性”三者是几乎不可能的。只能选择其中两个, 他们的组合方式为:

- CP：当一套系统在发生分区故障后，客户端的任何请求都被卡死或者超时，但是，系统的每个节点总是会返回一致的数据. 比如Zookeeper。比如跨行转账，一次转账请求要等待双方银行系统都完成整个事务才算完成。产生的问题: 由于网络问题的存在CP系统可能会出现待等待超时，如果没有处理超时问题则整理系统会出现阻塞。

- AP：当一套系统在发生分区故障后，可以返回不一致数据, 放弃强一致性仅追求最终一致性，很多NoSQL数据库按照AP进行设计。✨追求最终一致性是指允许暂时的数据不一致，只要最终在用户接受的时间内数据一致即可。

- CA：放弃分区容忍性，加强一致性和可用性，关系数据库按照CA进行设计。不要分区, 现实中不存在, 因为，在分布式系统内，P是必然的发生的，不选P，一旦发生分区错误，整个分布式系统就完全无法使用了，这是不符合实际需要的。所以，对于分布式系统，我们只能能考虑当发生分区错误时，如何选择一致性和可用性。

总结： 在分布式系统设计中AP的应用较多，即保证分区容忍性和可用性，牺牲数据的强一致性（写操作后立刻读取到最新数据），保证数据最终一致性。比如：订单退款，今日退款成功，明日账户到账，只要在预定的用户可以接受的时间内退款事务走完即可。

## BASE理论

所谓的“牺牲一致性”并不是完全放弃数据一致性，而是牺牲强一致性换取弱一致性，这样我们就有兼顾全局的可能。BASE理论：

- BA：Basic Available 基本可用

    整个系统在某些不可抗力的情况下，仍然能够保证“可用性”，即一定时间内仍然能够返回一个明确的结果。只不过“基本可用”和“高可用”的区别是：

    - 一定时间可以适当延长, 如当举行大促时，响应时间可以适当延长；
    - 返回结果进行降级, 如给部分用户直接返回一个降级页面，从而缓解服务器压力。

- S：Soft State：柔性状态

    同一数据的不同副本的状态，可以不需要实时一致。

- E：Eventual Consisstency：最终一致性

    同一数据的不同副本的状态，可以不需要实时一致，但一定要保证经过一定时间后仍然是一致的。


### 分布式组件与CAP理论

|应用名字|应用类型|CP/AP|分布式协议|描述|
|----|----|----|----|----|
|Nacos|注册中心|AP/CP|1.AP:distro（Nacos自定义的分布式一致性协议）2.CP:简化版raft|客户端在向Nacos进行注册时，可以通过ephemeral选择AP或CP模式|
|Eureka|注册中心|AP|对等复制（PeertoPeer）|
|Consul|注册中心|CP|raft|客户端在向Nacos进行注册时，通过ephemeral=false来选择CP模式|
|Zookeeper|分布式协调组件、注册中心|CP|ZAB||
|Redis|NoSql|AP|主从异步同步数据|写操作操作主节点，主节点将写操作异步同步到从节点|




## 参考

- <https://cloud.tencent.com/developer/article/1860632>
