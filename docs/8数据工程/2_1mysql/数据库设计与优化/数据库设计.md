# 数据库设计

## 命名与表设计规范

​规范并不是千遍一律， 但要在自己的项目体系内形成一套有效规范， 以下规范可作参考：

- 命名规范

    - 命名有意义，一眼知道这张表是干什么用的
    - 数据库，表都用小写
        - 数据库形如：backend
        - 数据表形如：client_device_info(客户端设备信息)，不要缩写，字母全小写
    - 索引命名以idx_为前缀
    - 命名不要过长（应尽量少于25字符）
    - 不要使用保留字
    - 同一字段在不同的表中也应是相同的类型和长度
    - 同一数据库下有不同的模块，可以考虑对表名用不同的前缀标识
    - 备份表时加上时间标识

- 表设计规范

    - 如果没有特殊情况，建议选择InnoDB引擎
    - 每个表都应该有主键，可选择自增字段，或长整型字段。例外情况，如果有多个字段可以组成唯一， 并且需要频繁查询的， 那么可以采用复合主键，比如用户编号+交易商编号做为复合主键，因为可以确保不产生重复数据， 同时节省空间。
    - (不做强制要求)尽量将字段设置为NOT NULL。因为NULL值的存储需要额外的空间，且会导致比较运算更为复杂，会使得优化器更难以优化sql。空值是不占用空间, 但NULL列需要占用一个额外字节。
    - 使用更短小的列，比如整型列。整型列的执行速度往往更快。
    - 存储精确浮点数必须使用DECIMAL代替float和double。
    - 建议使用unsigned类型存储非负值
    - 建议使用 int unsigned存储ipv4
    - 整型定义中不添加显示长度的值，使用int，而不是int(4)
    - 尽可能不要使用text,blob类型
    - varchar（n） n表示字符数而不是字节数，比如varchar（255）最大可存储255个汉字，需根据实际字符长度选择n的值。
    - 字符集建议选择utf-8
    - 存储年时使用year类型
    - 存储日期时使用date类型
    - 存储时间时，建议使用timestamp类型，因为timestamp使用的是4字节，datetime使用的是8字节。
    - 不要在数据库中使用varbinary或blob存储图片及文件，mysql 并不适合大量存储这类型文件
    - join 操作的字段，在不同表中的类型及命名要一致
    - 如果更改表结构会影响性能，需要找DBA、表设计人员进行联合评审。

## 数据库设计原则

- 核心原则

    - 不在数据库做运算;  cpu计算务必移至业务层;  
    - 控制每个表的列数量(字段少而精,字段数建议在20以内);
    - 平衡范式与冗余(效率优先；往往牺牲范式)  
    - 拒绝3B(拒绝大sql语句：big sql、拒绝大事物：big transaction、拒绝大批量：big batch);  

- 字段类原则

    - 用好数值类型(用合适的字段类型节约空间);  
    - 字符转化为数字(能转化的最好转化,同样节约空间、提高查询性能);  
    - 避免使用NULL字段(NULL字段很难查询优化、NULL字段的索引需要额外空间、NULL字段的复合索引无效);  
    - 少用text类型(尽量使用varchar代替text字段);  

- 索引类原则  

    - 合理使用索引(改善查询,减慢更新,索引一定不是越多越好);  
    - 字符字段大量重复属性时， 尽量建前缀索引（比如地区chinaXXX, alter table x_test add index(x_city(6)) ）;  不在索引做列运算;  
    - innodb主键推荐使用自增列(主键建立聚簇索引,主键不应该被修改,字符串不应该做主键)
    - 不用外键(由程序保证约束);

- SQL类原则

    - sql语句尽可能简单(一条sql只能在一个cpu运算,大语句拆小语句,减少锁时间,一条大sql可以堵死整个库);  
    - 避免使用trig/func(触发器、函数,  采用程序取而代之);  
    - 大批量SQL的更新操作要开启事务，越多效果性能越明显。



## PowerDesigner

### 简介

PowerDesigner是一款功能非常强大的建模工具软件，也是最流行的建模软件之一。它的发展历程是怎样？ 相比其他主流工具有什么区别？ 比如Rational Rose， 它是专攻UML对象模型的建模工具，之后才向数据库建模发展；而PowerDesigner正好相反，它是以数据库建模起家，后来才发展为一款综合全面的Case工具。

### PD建模类型

- 概念数据模型 (CDM)

    对数据和信息进行建模，利用实体-关系图（E-R图）的形式组织数据，检验数据设计的有效性和合理性。

- 逻辑数据模型 (LDM)

    逻辑模型中一方面显示了实体、实体的属性和实体之间的关系；另一方面又将继承、实体关系中的引用等在实体的属性中进行展示。逻辑模型介于概念模型和物理模型之间，具有物理模型方面的特性，逻辑模型主要是使得整个概念模型更易于理解，同时又不依赖于具体的数据库实现，使用逻辑模型可以生成针对具体数据库管理系统的物理模型。逻辑模型并不是在整个步骤中必须的，可以直接从概念模型来生成物理模型。

- 物理数据模型 (PDM)

    基于特定DBMS，在概念数据模型、逻辑数据模型的基础上进行设计。由物理数据模型生成数据库，或对数据库进行逆向工程得到物理数据模型。

- 面向对象模型 (OOM)

    描述业务和操作员之间的关系， 通过UML图进行表示， 比如常见的图形：类图、对象图、包图、用例图、时序图、协作图、交互图、活动图、状态图、组件图、复合结构图、部署图（配置图）。OOM 本质上是软件系统的一个静态的概念模型。

- 业务程序模型 (BPM)

    BPM 描述业务的不同内在任务与流程，帮助大家识别、描述和分解业务流程。PM 是从业务合伙人的观点来看业务逻辑和规则的概念模型，使用一个图表描述程序，流程，信息和合作协议之间的交互作用。

- 信息流模型（ILM）

    ILM是一个高层的信息流模型，主要用于分布式数据库之间的数据复制。

- 企业架构模型（EAM）

    从业务层、应用层以及技术层的对企业的体系架构进行全方面的描述。包括：组织结构图、业务通信图、进程图、城市规划图、应用架构图、面向服务图、技术基础框架图。